{% extends "base.html" %}

{% block title %}ML Model Management - KI Smart Home{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ü§ñ ML Model Management</h2>
    <p>Verwaltung und Versionierung der Machine Learning Modelle</p>
</div>

<!-- Model Cards -->
<div id="models-container" style="display: grid; gap: 1.5rem;">
    <div class="loading">Lade Modelle...</div>
</div>

<style>
.model-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.model-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eee;
}

.model-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #333;
}

.model-version-badge {
    background: #4CAF50;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9em;
}

.model-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.metric-box {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 6px;
    text-align: center;
}

.metric-label {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 0.3rem;
}

.metric-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #4CAF50;
}

.version-history {
    margin-top: 1.5rem;
}

.version-item {
    background: #f9f9f9;
    padding: 0.8rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.version-item.current {
    background: #E8F5E9;
    border-left: 4px solid #4CAF50;
}

.version-info {
    flex-grow: 1;
}

.version-timestamp {
    font-size: 0.85em;
    color: #666;
}

.version-metrics {
    font-size: 0.9em;
    color: #333;
    margin-top: 0.3rem;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.3s;
}

.btn-primary {
    background: #4CAF50;
    color: white;
}

.btn-primary:hover {
    background: #45a049;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-danger:hover {
    background: #da190b;
}

.btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}
</style>

<script>
async function loadModels() {
    try {
        const response = await fetch('/api/models/versions');
        const data = await response.json();

        if (data.success) {
            displayModels(data.models);
        } else {
            document.getElementById('models-container').innerHTML =
                '<div class="loading">‚ùå Fehler beim Laden der Modelle</div>';
        }
    } catch (error) {
        console.error('Error loading models:', error);
        document.getElementById('models-container').innerHTML =
            '<div class="loading">‚ùå Fehler beim Laden der Modelle</div>';
    }
}

function displayModels(models) {
    const container = document.getElementById('models-container');

    if (Object.keys(models).length === 0) {
        container.innerHTML = '<div class="loading">Keine trainierten Modelle gefunden</div>';
        return;
    }

    container.innerHTML = Object.entries(models).map(([name, info]) => {
        const currentVersion = info.current_version || 'N/A';
        const versionsCount = info.versions_count || 0;
        const metrics = info.current_metrics || {};

        // Format metrics
        let metricsHTML = '';
        if (metrics.accuracy !== undefined) {
            metricsHTML += `
                <div class="metric-box">
                    <div class="metric-label">Accuracy</div>
                    <div class="metric-value">${(metrics.accuracy * 100).toFixed(1)}%</div>
                </div>
            `;
        }
        if (metrics.mae !== undefined) {
            metricsHTML += `
                <div class="metric-box">
                    <div class="metric-label">MAE</div>
                    <div class="metric-value">${metrics.mae.toFixed(2)}¬∞C</div>
                </div>
            `;
        }
        if (metrics.r2_score !== undefined) {
            metricsHTML += `
                <div class="metric-box">
                    <div class="metric-label">R¬≤ Score</div>
                    <div class="metric-value">${(metrics.r2_score * 100).toFixed(1)}%</div>
                </div>
            `;
        }

        // Version History
        const historyHTML = (info.history || []).map((version, idx) => {
            const isCurrent = idx === info.history.length - 1;
            const timestamp = new Date(version.timestamp).toLocaleString('de-DE');
            const versionMetrics = version.metrics || {};

            let versionMetricsText = '';
            if (versionMetrics.accuracy) {
                versionMetricsText = `Accuracy: ${(versionMetrics.accuracy * 100).toFixed(1)}%`;
            } else if (versionMetrics.mae) {
                versionMetricsText = `MAE: ${versionMetrics.mae.toFixed(2)}¬∞C, R¬≤: ${(versionMetrics.r2_score * 100).toFixed(1)}%`;
            }

            return `
                <div class="version-item ${isCurrent ? 'current' : ''}">
                    <div class="version-info">
                        <div class="version-timestamp">${timestamp} ${isCurrent ? '(Aktuell)' : ''}</div>
                        <div class="version-metrics">${versionMetricsText}</div>
                        ${version.notes ? `<div style="font-size: 0.85em; color: #999; margin-top: 0.2rem;">${version.notes}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="model-card">
                <div class="model-header">
                    <div class="model-title">${name}</div>
                    <div class="model-version-badge">v${currentVersion}</div>
                </div>

                ${metricsHTML ? `<div class="model-metrics">${metricsHTML}</div>` : '<p>Keine Metriken verf√ºgbar</p>'}

                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn btn-danger" onclick="rollbackModel('${name}')" ${versionsCount < 2 ? 'disabled' : ''}>
                        ‚Ü∂ Rollback zur vorherigen Version
                    </button>
                    <div style="flex-grow: 1;"></div>
                    <span style="color: #666; font-size: 0.9em;">${versionsCount} Version(en)</span>
                </div>

                ${historyHTML ? `
                    <div class="version-history">
                        <h4 style="margin-bottom: 0.5rem;">üìú Version History</h4>
                        ${historyHTML}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

async function rollbackModel(modelName) {
    if (!confirm(`M√∂chtest du wirklich ${modelName} zur vorherigen Version zur√ºckrollen?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/models/${modelName}/rollback`, {
            method: 'POST'
        });
        const data = await response.json();

        if (data.success) {
            alert(`‚úÖ ${modelName} erfolgreich zur√ºckgerollt!`);
            loadModels(); // Reload
        } else {
            alert(`‚ùå Rollback fehlgeschlagen: ${data.error}`);
        }
    } catch (error) {
        console.error('Error rolling back model:', error);
        alert('‚ùå Fehler beim Rollback');
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
});
</script>
{% endblock %}
